<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sky Ascender</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            touch-action: none; 
            overflow: hidden; 
            background-color: #111827; 
            margin: 0;
            font-family: 'Courier New', Courier, monospace;
        }
        /* Disable blue highlight on tap */
        * { -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }

        @keyframes scale-up-down {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .animate-scale {
            animation: scale-up-down 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Configuration ---
        const GRAVITY = 0.4;
        const JUMP_FORCE = -9.5; 
        const MOVEMENT_SPEED = 6;
        const PLAYER_SIZE = 30;
        const PLATFORM_WIDTH = 60;
        const PLATFORM_HEIGHT = 15;
        const SCREEN_WIDTH = Math.min(window.innerWidth, 500);

        // --- Graphics ---
        const HeroIcon = () => (            
            <svg viewBox="0 0 100 100" className="w-full h-full filter drop-shadow-lg">
                <circle cx="50" cy="50" r="45" fill="#3b82f6" stroke="#1d4ed8" strokeWidth="5" />
                <circle cx="35" cy="35" r="12" fill="white" />
                <circle cx="35" cy="35" r="5" fill="black" />
                <circle cx="65" cy="35" r="12" fill="white" />
                <circle cx="65" cy="35" r="5" fill="black" />
                <path d="M 35 70 Q 50 80 65 70" stroke="white" strokeWidth="3" fill="none" />
            </svg>
        );

        const CatIcon = () => (
            <svg viewBox="0 0 100 100" className="w-full h-full filter drop-shadow-2xl">
                <path d="M 20 30 L 10 10 L 35 25 Z" fill="#f97316" stroke="#ea580c" strokeWidth="2" />
                <path d="M 20 28 L 15 15 L 32 26 Z" fill="#fed7aa" />
                <path d="M 80 30 L 90 10 L 65 25 Z" fill="#f97316" stroke="#ea580c" strokeWidth="2" />
                <path d="M 80 28 L 85 15 L 68 26 Z" fill="#fed7aa" />
                <circle cx="50" cy="55" r="35" fill="#f97316" stroke="#ea580c" strokeWidth="2" />
                <ellipse cx="50" cy="60" rx="28" ry="25" fill="#fed7aa" />
                <ellipse cx="38" cy="50" rx="6" ry="10" fill="#065f46" stroke="#064e3b" strokeWidth="1" />
                <ellipse cx="38" cy="48" rx="3" ry="5" fill="#10b981" />
                <circle cx="38" cy="46" r="2" fill="white" />
                <ellipse cx="62" cy="50" rx="6" ry="10" fill="#065f46" stroke="#064e3b" strokeWidth="1" />
                <ellipse cx="62" cy="48" rx="3" ry="5" fill="#10b981" />
                <circle cx="62" cy="46" r="2" fill="white" />
                <path d="M 50 60 L 47 65 L 53 65 Z" fill="#ec4899" />
                <path d="M 50 65 L 50 68" stroke="#ea580c" strokeWidth="2" />
                <path d="M 50 68 Q 42 72 38 70" stroke="#ea580c" strokeWidth="2" fill="none" />
                <path d="M 50 68 Q 58 72 62 70" stroke="#ea580c" strokeWidth="2" fill="none" />
                <line x1="15" y1="55" x2="32" y2="53" stroke="#ea580c" strokeWidth="1.5" />
                <line x1="15" y1="60" x2="32" y2="60" stroke="#ea580c" strokeWidth="1.5" />
                <line x1="15" y1="65" x2="32" y2="67" stroke="#ea580c" strokeWidth="1.5" />
                <line x1="85" y1="55" x2="68" y2="53" stroke="#ea580c" strokeWidth="1.5" />
                <line x1="85" y1="60" x2="68" y2="60" stroke="#ea580c" strokeWidth="1.5" />
                <line x1="85" y1="65" x2="68" y2="67" stroke="#ea580c" strokeWidth="1.5" />
                <circle cx="30" cy="62" r="2" fill="#fbbf24" opacity="0.4" />
                <circle cx="70" cy="62" r="2" fill="#fbbf24" opacity="0.4" />
                <path d="M 32 42 Q 38 40 44 42" stroke="#ea580c" strokeWidth="1.5" fill="none" opacity="0.6" />
                <path d="M 56 42 Q 62 40 68 42" stroke="#ea580c" strokeWidth="1.5" fill="none" opacity="0.6" />
            </svg>
        );

        const DogIcon = () => (
            <svg viewBox="0 0 100 100" className="w-full h-full filter drop-shadow-2xl">
                <ellipse cx="25" cy="45" rx="12" ry="25" fill="#92400e" stroke="#78350f" strokeWidth="2" 
                        transform="rotate(-20 25 45)" />
                <ellipse cx="25" cy="45" rx="7" ry="18" fill="#d97706" 
                        transform="rotate(-20 25 45)" />
                <ellipse cx="75" cy="45" rx="12" ry="25" fill="#92400e" stroke="#78350f" strokeWidth="2" 
                        transform="rotate(20 75 45)" />
                <ellipse cx="75" cy="45" rx="7" ry="18" fill="#d97706" 
                        transform="rotate(20 75 45)" />
                <circle cx="50" cy="50" r="32" fill="#d97706" stroke="#92400e" strokeWidth="2" />
                <ellipse cx="50" cy="62" rx="22" ry="18" fill="#fbbf24" />
                <ellipse cx="50" cy="32" rx="10" ry="8" fill="#92400e" opacity="0.6" />
                <ellipse cx="38" cy="45" rx="5" ry="8" fill="#422006" stroke="#1c0a00" strokeWidth="1" />
                <circle cx="38" cy="43" r="2" fill="white" />
                <ellipse cx="62" cy="45" rx="5" ry="8" fill="#422006" stroke="#1c0a00" strokeWidth="1" />
                <circle cx="62" cy="43" r="2" fill="white" />
                <ellipse cx="50" cy="58" rx="6" ry="5" fill="#1c0a00" />
                <ellipse cx="48" cy="57" rx="2" ry="1.5" fill="#78350f" opacity="0.6" />
                <path d="M 50 58 L 50 65" stroke="#1c0a00" strokeWidth="2" />
                <path d="M 50 65 Q 42 68 38 66" stroke="#1c0a00" strokeWidth="2" fill="none" />
                <path d="M 50 65 Q 58 68 62 66" stroke="#1c0a00" strokeWidth="2" fill="none" />
                <ellipse cx="50" cy="70" rx="8" ry="5" fill="#ec4899" stroke="#be185d" strokeWidth="1" />
                <path d="M 50 67 L 50 73" stroke="#be185d" strokeWidth="1" />
                <path d="M 32 38 Q 38 36 44 38" stroke="#78350f" strokeWidth="2" fill="none" />
                <path d="M 56 38 Q 62 36 68 38" stroke="#78350f" strokeWidth="2" fill="none" />
                <circle cx="38" cy="62" r="1.5" fill="#92400e" opacity="0.5" />
                <circle cx="42" cy="65" r="1" fill="#92400e" opacity="0.5" />
                <circle cx="62" cy="62" r="1.5" fill="#92400e" opacity="0.5" />
                <circle cx="58" cy="65" r="1" fill="#92400e" opacity="0.5" />
                <ellipse cx="32" cy="58" rx="4" ry="3" fill="#fcd34d" opacity="0.4" />
                <ellipse cx="68" cy="58" rx="4" ry="3" fill="#fcd34d" opacity="0.4" />
            </svg>
        );

        const RocketIcon = () => (
            <svg viewBox="0 0 100 100" className="w-full h-full filter drop-shadow-2xl">
                <ellipse cx="50" cy="60" rx="15" ry="35" fill="#e5e7eb" stroke="#9ca3af" strokeWidth="2" />
                <path d="M 35 25 L 50 5 L 65 25 Z" fill="#ef4444" stroke="#b91c1c" strokeWidth="2" />
                <circle cx="50" cy="45" r="8" fill="#60a5fa" stroke="#1e40af" strokeWidth="2" />
                <circle cx="50" cy="45" r="5" fill="#93c5fd" opacity="0.6" />
                <path d="M 35 70 L 25 85 L 35 80 Z" fill="#3b82f6" stroke="#1e40af" strokeWidth="2" />
                <path d="M 65 70 L 75 85 L 65 80 Z" fill="#3b82f6" stroke="#1e40af" strokeWidth="2" />
                <ellipse cx="50" cy="95" rx="8" ry="12" fill="#fbbf24" opacity="0.8" />
                <ellipse cx="42" cy="93" rx="5" ry="10" fill="#f97316" opacity="0.7" />
                <ellipse cx="58" cy="93" rx="5" ry="10" fill="#f97316" opacity="0.7" />
                <ellipse cx="50" cy="100" rx="4" ry="8" fill="#ef4444" opacity="0.6" />
                <line x1="35" y1="55" x2="65" y2="55" stroke="#9ca3af" strokeWidth="1" opacity="0.5" />
                <line x1="35" y1="65" x2="65" y2="65" stroke="#9ca3af" strokeWidth="1" opacity="0.5" />
                <circle cx="15" cy="20" r="1.5" fill="#fbbf24" />
                <circle cx="85" cy="25" r="1" fill="#fbbf24" />
                <circle cx="20" cy="80" r="1" fill="#fbbf24" />
                <circle cx="80" cy="70" r="1.5" fill="#fbbf24" />
                <circle cx="10" cy="50" r="1" fill="#fbbf24" />
                <circle cx="90" cy="45" r="1" fill="#fbbf24" />
            </svg>
        );

        const NinjaIcon = () => (
            <svg viewBox="0 0 100 100" className="w-full h-full filter drop-shadow-2xl">
                <circle cx="50" cy="50" r="35" fill="#1e293b" stroke="#0f172a" strokeWidth="2" />
                <ellipse cx="50" cy="28" rx="36" ry="8" fill="#dc2626" stroke="#991b1b" strokeWidth="2" />
                <rect x="14" y="24" width="72" height="8" fill="#dc2626" />
                <path d="M 12 28 L 5 25 L 8 32 L 12 30 Z" fill="#dc2626" stroke="#991b1b" strokeWidth="1" />
                <path d="M 5 25 L 2 20 L 0 28 Z" fill="#b91c1c" stroke="#991b1b" strokeWidth="1" />
                <path d="M 88 28 L 95 25 L 92 32 L 88 30 Z" fill="#dc2626" stroke="#991b1b" strokeWidth="1" />
                <path d="M 95 25 L 98 20 L 100 28 Z" fill="#b91c1c" stroke="#991b1b" strokeWidth="1" />
                <ellipse cx="50" cy="60" rx="30" ry="22" fill="#0f172a" />
                <rect x="20" y="38" width="60" height="18" fill="#fef3c7" rx="2" />
                <ellipse cx="35" cy="47" rx="8" ry="10" fill="#422006" stroke="#1c0a00" strokeWidth="1" />
                <ellipse cx="35" cy="45" rx="4" ry="6" fill="#78350f" />
                <circle cx="36" cy="44" r="2" fill="white" />
                <ellipse cx="65" cy="47" rx="8" ry="10" fill="#422006" stroke="#1c0a00" strokeWidth="1" />
                <ellipse cx="65" cy="45" rx="4" ry="6" fill="#78350f" />
                <circle cx="66" cy="44" r="2" fill="white" />
                <path d="M 26 40 L 44 38" stroke="#1c0a00" strokeWidth="2" />
                <path d="M 74 40 L 56 38" stroke="#1c0a00" strokeWidth="2" />
                <path d="M 25 55 Q 50 58 75 55" stroke="#334155" strokeWidth="1" opacity="0.5" fill="none" />
                <path d="M 28 62 Q 50 65 72 62" stroke="#334155" strokeWidth="1" opacity="0.5" fill="none" />
                <g transform="translate(50, 20) scale(0.4)">
                    <path d="M 0,-10 L 2,-2 L 10,0 L 2,2 L 0,10 L -2,2 L -10,0 L -2,-2 Z" 
                        fill="#71717a" stroke="#52525b" strokeWidth="1" />
                    <circle cx="0" cy="0" r="2" fill="#27272a" />
                </g>
                <ellipse cx="35" cy="54" rx="6" ry="2" fill="#1c0a00" opacity="0.2" />
                <ellipse cx="65" cy="54" rx="6" ry="2" fill="#1c0a00" opacity="0.2" />
                <ellipse cx="50" cy="26" rx="15" ry="2" fill="#ef4444" opacity="0.6" />
            </svg>
        );

        const PlatformIcon = () => (
            <div className="w-full h-full bg-gradient-to-b from-green-400 to-green-600 rounded-md border-t-4 border-green-300 shadow-lg"></div>
        );

        const CoinIcon = () => (
            <svg viewBox="0 0 100 100" className="w-full h-full filter drop-shadow-md animate-pulse">
                <circle cx="50" cy="50" r="45" fill="#fbbf24" stroke="#d97706" strokeWidth="5" />
                <text x="50" y="72" fontSize="60" textAnchor="middle" fill="#92400e" fontWeight="bold" fontFamily="sans-serif">$</text>
            </svg>
        );

        const HeartIcon = () => (
            <svg viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6 text-red-500 drop-shadow-md">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
            </svg>
        );

        const SpeakerIcon = ({ muted }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-8 h-8 text-white drop-shadow-md">
                {muted ? (
                    <g><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><line x1="23" y1="9" x2="17" y2="15" /><line x1="17" y1="9" x2="23" y2="15" /></g>
                ) : (
                    <g><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" /></g>
                )}
            </svg>
        );

        const SpaceLayer = React.memo(({ cameraY }) => {
            const items = React.useMemo(() => {
                const stars = Array.from({length: 50}, () => ({
                    left: Math.random() * 100,
                    top: Math.random() * 100,
                    size: Math.random() * 3 + 1,
                    color: Math.random() > 0.7 ? '#fde047' : 'white',
                    speed: Math.random() * 0.5 + 0.1
                }));
                const planets = Array.from({length: 3}, () => ({
                    left: Math.random() * 90,
                    top: Math.random() * 100,
                    size: Math.random() * 60 + 30,
                    hue: Math.random() * 360,
                    speed: Math.random() * 0.2 + 0.05
                }));
                return { stars, planets };
            }, []);

            return (
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                    {items.stars.map((s, i) => (
                        <div key={i} className="absolute rounded-full"
                            style={{
                                left: `${s.left}%`,
                                top: `${((s.top + cameraY * s.speed * 0.05) % 100 + 100) % 100}%`,
                                width: s.size,
                                height: s.size,
                                backgroundColor: s.color,
                                boxShadow: `0 0 ${s.size}px ${s.color}`,
                                opacity: Math.random() * 0.5 + 0.5
                        }}
                        />
                    ))}
                    {items.planets.map((p, i) => (
                        <div key={`p-${i}`} className="absolute rounded-full opacity-40"
                            style={{
                                left: `${p.left}%`,
                                top: `${((p.top + cameraY * p.speed * 0.02) % 100 + 100) % 100}%`,
                                width: p.size,
                                height: p.size,
                                background: `radial-gradient(circle at 30% 30%, hsl(${p.hue}, 70%, 60%), hsl(${p.hue}, 70%, 20%))`
                            }}
                        />
                    ))}
                </div>
            );
        });

        const App = () => {
            const [gameState, setGameState] = useState('START');
            const [score, setScore] = useState(0);
            const [highScore, setHighScore] = useState(0);
            const [isMuted, setIsMuted] = useState(false);
            const [coins, setCoins] = useState(0);
            const [lives, setLives] = useState(3);
            const [showShop, setShowShop] = useState(false);
            const [ownedSkins, setOwnedSkins] = useState(['default']);
            const [currentSkin, setCurrentSkin] = useState('default');
            const [theme, setTheme] = useState('SKY');
            const [, setTick] = useState(0); // Force render

            useEffect(() => {
                const timer = setInterval(() => {
                    setTheme(prev => prev === 'SKY' ? 'SPACE' : 'SKY');
                }, 20000);
                return () => clearInterval(timer);
            }, []);

            const SKINS = [
                { id: 'default', name: 'Mr. Bounce', price: 0, Component: HeroIcon },
                { id: 'cat', name: 'Meow-teor', price: 12, Component: CatIcon },
                { id: 'dog', name: 'Bark-stonaut', price: 12, Component: DogIcon },
                { id: 'rocket', name: 'Zoom-Tube', price: 15, Component: RocketIcon },
                { id: 'ninja', name: 'Jump-Jiutsu', price: 17, Component: NinjaIcon },
            ];

            // Refs
            const player = useRef({ x: SCREEN_WIDTH / 2, y: 0, vx: 0, vy: 0 });
            const platforms = useRef([]);
            const coinsRef = useRef([]);
            const boosterEndTime = useRef(0);
            const camera = useRef({ y: 0 });
            const inputs = useRef({ left: false, right: false });
            const isMutedRef = useRef(false);
            const livesRef = useRef(3);
            const reqRef = useRef();              // Audio Context Ref
            const audioCtxRef = useRef(null);

            // Initialize Audio Engine
            const initAudio = () => {
                if (!audioCtxRef.current) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) {
                        audioCtxRef.current = new AudioContext();
                    }
                }
                // Mobile browsers require resuming context on user gesture
                if (audioCtxRef.current && audioCtxRef.current.state === 'suspended') {
                    audioCtxRef.current.resume();
                }
            };

            // Play Synthesized Jump Sound
            const playJumpSound = () => {
                if (isMutedRef.current || !audioCtxRef.current) return;

                const ctx = audioCtxRef.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.connect(gain);
                gain.connect(ctx.destination);

                // Sound properties (Rising pitch for jump)
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.1);

                // Volume envelope (Fade out)
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);

                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            };

            const toggleMute = () => {
                setIsMuted(prev => {
                    isMutedRef.current = !prev;
                    return !prev;
                });
            };

            // Start Game
            const initGame = () => {
                initAudio(); // Unlock audio on Start button tap

                // Reset Game State
                const startY = window.innerHeight - 100;
                player.current = { x: SCREEN_WIDTH / 2 - PLAYER_SIZE/2, y: startY - 100, vx: 0, vy: JUMP_FORCE };
                camera.current.y = 0;
                setScore(0);
                setLives(3);
                livesRef.current = 3;
                // setCoins(0);

                let newPlatforms = [];
                for (let i = 0; i < 15; i++) {
                    newPlatforms.push({
                        id: i,
                        x: Math.random() * (SCREEN_WIDTH - PLATFORM_WIDTH),
                        y: startY - (i * 100)
                    });
                }
                newPlatforms[0].x = SCREEN_WIDTH / 2 - PLATFORM_WIDTH/2;
                newPlatforms[0].y = startY;
                
                platforms.current = newPlatforms;
                coinsRef.current = [];
                setGameState('PLAYING');
            };

            const buySkin = (skinId, price) => {
                if (ownedSkins.includes(skinId)) {
                    setCurrentSkin(skinId);
                } else if (coins >= price) {
                    setCoins(c => c - price);
                    setOwnedSkins(prev => [...prev, skinId]);
                    setCurrentSkin(skinId);
                }
            };

            const buyBooster = () => {
                if (coins >= 12) {
                    setCoins(c => c - 12);
                    boosterEndTime.current = Date.now() + 10000;
                    setShowShop(false);
                }
            };

            // Game Loop
            const update = () => {
                if (gameState !== 'PLAYING') return;

                const p = player.current;
                p.vy += GRAVITY;
                p.y += p.vy;

                if (inputs.current.left) p.x -= MOVEMENT_SPEED;
                if (inputs.current.right) p.x += MOVEMENT_SPEED;

                // Wrap
                if (p.x < -PLAYER_SIZE/2) p.x = SCREEN_WIDTH - PLAYER_SIZE/2;
                if (p.x > SCREEN_WIDTH - PLAYER_SIZE/2) p.x = -PLAYER_SIZE/2;

                // Camera
                const targetY = p.y - (window.innerHeight * 0.6); 
                if (targetY < camera.current.y) {
                    camera.current.y = targetY;
                    const newScore = Math.floor(-camera.current.y / 10);
                    if(newScore > score) setScore(newScore);
                }

                // Collision
                if (p.vy > 0) {
                    platforms.current.forEach(plat => {
                        if (
                            p.x + PLAYER_SIZE * 0.8 > plat.x && 
                            p.x + PLAYER_SIZE * 0.2 < plat.x + PLATFORM_WIDTH &&
                            p.y + PLAYER_SIZE >= plat.y &&
                            p.y + PLAYER_SIZE <= plat.y + 15
                        ) {
                            const isBoosted = Date.now() < boosterEndTime.current;
                            p.vy = isBoosted ? JUMP_FORCE * 1.45 : JUMP_FORCE;
                            playJumpSound(); // Play sound effect
                        }
                    });
                }

                // Coin Collision
                coinsRef.current.forEach(coin => {
                    if (!coin.collected && 
                        p.x < coin.x + 30 &&
                        p.x + PLAYER_SIZE > coin.x &&
                        p.y < coin.y + 30 &&
                        p.y + PLAYER_SIZE > coin.y
                    ) {
                        coin.collected = true;
                        setCoins(c => c + 1);
                    }
                });

                // Platforms
                platforms.current = platforms.current.filter(plat => plat.y < camera.current.y + window.innerHeight + 100);
                coinsRef.current = coinsRef.current.filter(c => !c.collected && c.y < camera.current.y + window.innerHeight + 100);

                const highestPlat = platforms.current[platforms.current.length - 1];
                if (highestPlat && highestPlat.y > camera.current.y - 100) {
                    const newY = highestPlat.y - (75 + Math.random() * 35);
                    const newX = Math.random() * (SCREEN_WIDTH - PLATFORM_WIDTH);
                    platforms.current.push({
                        id: Math.random(),
                        x: newX,
                        y: newY
                    });

                    // Spawn Coin (45% chance)
                    if (Math.random() < 0.45) {
                        // Randomize position: anywhere horizontally, and vertically between the two platforms
                        const coinX = Math.random() * (SCREEN_WIDTH - 30);
                        const minY = newY - 50; // Highest point (visually)
                        const maxY = highestPlat.y - 60; // Lowest point (visually)
                        const coinY = minY + Math.random() * (maxY - minY);

                        coinsRef.current.push({
                            id: Math.random(),
                            x: coinX,
                            y: coinY,
                            collected: false
                        });
                    }
                }

                // Game Over
                if (p.y > camera.current.y + window.innerHeight) {
                    if (livesRef.current > 1) {
                        livesRef.current -= 1;
                        setLives(livesRef.current);
                        
                        // Respawn logic: Find a platform closest to the lower-middle of the screen
                        // This prevents the camera from jumping up and artificially increasing the score
                        const targetRespawnY = camera.current.y + window.innerHeight * 0.75;
                        let bestPlat = platforms.current[0]; 
                        let minDiff = Infinity;

                        for (const plat of platforms.current) {
                            const diff = Math.abs(plat.y - targetRespawnY);
                            if (diff < minDiff) {
                                minDiff = diff;
                                bestPlat = plat;
                            }
                        }

                        if (bestPlat) {
                            p.x = bestPlat.x + PLATFORM_WIDTH / 2 - PLAYER_SIZE / 2;
                            p.y = bestPlat.y - PLAYER_SIZE - 5;
                            p.vy = 0;
                        } else {
                            // Fallback if no platforms found (rare)
                            p.y = camera.current.y + window.innerHeight / 2;
                            p.vy = 0;
                        }
                    } else {
                        setHighScore(s => Math.max(s, Math.floor(-camera.current.y / 10)));
                        setGameState('GAME_OVER');
                    }
                }

                setTick(t => t + 1);
                reqRef.current = requestAnimationFrame(update);
            };

            useEffect(() => {
                if (gameState === 'PLAYING') {
                    reqRef.current = requestAnimationFrame(update);
                }
                return () => cancelAnimationFrame(reqRef.current);
            }, [gameState]);

            // Controls
            const handleTouch = (e) => {
                e.preventDefault();
                const touchX = e.touches[0].clientX;
                const middle = window.innerWidth / 2;
                if (touchX < middle) { inputs.current.left = true; inputs.current.right = false; }
                else { inputs.current.left = false; inputs.current.right = true; }
            };
            const handleTouchEnd = () => { inputs.current.left = false; inputs.current.right = false; };
            
            useEffect(() => {
                const down = (e) => { if(e.key === 'ArrowLeft') inputs.current.left = true; if(e.key === 'ArrowRight') inputs.current.right = true; };
                const up = (e) => { if(e.key === 'ArrowLeft') inputs.current.left = false; if(e.key === 'ArrowRight') inputs.current.right = false; };
                window.addEventListener('keydown', down);
                window.addEventListener('keyup', up);
                return () => { window.removeEventListener('keydown', down); window.removeEventListener('keyup', up); }
            }, []);

            return (
                <div className="w-full h-screen flex justify-center bg-gray-900">
                    <div 
                        className={`relative overflow-hidden shadow-2xl transition-colors duration-1000 ${theme === 'SPACE' ? 'bg-black' : 'bg-sky-900'}`}
                        style={{ width: SCREEN_WIDTH, height: '100%' }}
                        onTouchStart={handleTouch}
                        onTouchEnd={handleTouchEnd}
                        onTouchMove={handleTouch}
                    >
                        {/* Background Layers */}
                        {theme === 'SKY' && (
                            <div className="absolute inset-0 opacity-40 transition-opacity duration-1000" 
                                style={{
                                    background: 'radial-gradient(white 1px, transparent 1px)',
                                    backgroundSize: '30px 30px',
                                    backgroundPosition: `0px ${camera.current.y * 0.5}px`
                                }} 
                            />
                        )}
                        {theme === 'SPACE' && <SpaceLayer cameraY={camera.current.y} />}

                        {platforms.current.map(plat => (
                            <div key={plat.id} style={{ position: 'absolute', left: plat.x, top: plat.y - camera.current.y, width: PLATFORM_WIDTH, height: PLATFORM_HEIGHT }}>
                                <PlatformIcon />
                            </div>
                        ))}

                        {coinsRef.current.map(coin => (
                            <div key={coin.id} style={{ position: 'absolute', left: coin.x, top: coin.y - camera.current.y, width: 30, height: 30 }}>
                                <CoinIcon />
                            </div>
                        ))}
                        
                        <div style={{ position: 'absolute', left: player.current.x, top: player.current.y - camera.current.y, width: PLAYER_SIZE, height: PLAYER_SIZE }}>
                            {(() => {
                                const SkinComponent = SKINS.find(s => s.id === currentSkin)?.Component || HeroIcon;
                                return <SkinComponent />;
                            })()}
                        </div>

                        {/* HUD */}
                        {gameState === 'PLAYING' && (
                            <div className="absolute top-4 left-4 flex flex-col gap-2">
                                <div className="flex gap-2">
                                    <div className="bg-black/30 px-3 py-1 rounded text-white font-bold text-xl border border-white/20 backdrop-blur-sm">
                                        {Math.floor(-camera.current.y / 10)}m
                                    </div>
                                    <div className="bg-yellow-500/80 px-3 py-1 rounded text-white font-bold text-xl border border-yellow-300/50 backdrop-blur-sm flex items-center gap-1">
                                        <span>$</span> {coins}
                                    </div>
                                </div>
                                <div className="flex gap-1">
                                    {[...Array(lives)].map((_, i) => (
                                        <HeartIcon key={i} />
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Shop Button */}
                        {gameState === 'PLAYING' && (
                            <button 
                                onClick={(e) => { e.stopPropagation(); setShowShop(true); }}
                                onTouchStart={(e) => e.stopPropagation()}
                                className="absolute top-20 right-5 z-50 p-2 hover:bg-purple-500 text-white font-bold text-xs shadow-lg hover:scale-110 transition-transform bg-black/30 rounded border border-white/20 backdrop-blur-sm"
                            >
                                <svg viewBox="0 0 100 100" className="w-6 h-6 filter drop-shadow-md">
                                          {/* Awning/canopy stripes */}
                                          <path d="M 15 30 Q 50 20 85 30 L 85 40 Q 50 30 15 40 Z" 
                                                fill="#ef4444" stroke="#dc2626" strokeWidth="2" />
                                          <path d="M 25 30 Q 50 22 75 30 L 75 40 Q 50 32 25 40 Z" 
                                                fill="#fca5a5" opacity="0.6" />
                                          
                                          {/* Awning scalloped edge */}
                                          <path d="M 15 40 Q 20 45 25 40 Q 30 45 35 40 Q 40 45 45 40 Q 50 45 55 40 Q 60 45 65 40 Q 70 45 75 40 Q 80 45 85 40" 
                                                fill="#dc2626" stroke="#b91c1c" strokeWidth="1" />
                                          
                                          {/* Building main structure */}
                                          <rect x="20" y="45" width="60" height="45" fill="#fef3c7" stroke="#d97706" strokeWidth="2" />
                                          
                                          {/* Door */}
                                          <rect x="42" y="65" width="16" height="25" fill="#92400e" stroke="#78350f" strokeWidth="2" rx="1" />
                                          <circle cx="53" cy="77" r="1.5" fill="#fbbf24" />
                                          
                                          {/* Door window */}
                                          <rect x="45" y="68" width="10" height="8" fill="#bfdbfe" stroke="#78350f" strokeWidth="1" />
                                          <line x1="50" y1="68" x2="50" y2="76" stroke="#78350f" strokeWidth="0.5" />
                                          <line x1="45" y1="72" x2="55" y2="72" stroke="#78350f" strokeWidth="0.5" />
                                          
                                          {/* Left window */}
                                          <rect x="25" y="52" width="12" height="14" fill="#bfdbfe" stroke="#3b82f6" strokeWidth="2" rx="1" />
                                          <line x1="31" y1="52" x2="31" y2="66" stroke="#3b82f6" strokeWidth="1" />
                                          <line x1="25" y1="59" x2="37" y2="59" stroke="#3b82f6" strokeWidth="1" />
                                          
                                          {/* Right window */}
                                          <rect x="63" y="52" width="12" height="14" fill="#bfdbfe" stroke="#3b82f6" strokeWidth="2" rx="1" />
                                          <line x1="69" y1="52" x2="69" y2="66" stroke="#3b82f6" strokeWidth="1" />
                                          <line x1="63" y1="59" x2="75" y2="59" stroke="#3b82f6" strokeWidth="1" />
                                          
                                          {/* Window display items */}
                                          <circle cx="31" cy="59" r="3" fill="#fbbf24" opacity="0.7" />
                                          <rect x="67" y="56" width="4" height="6" fill="#ec4899" opacity="0.7" />
                                          
                                          {/* Shop sign */}
                                          <rect x="35" y="48" width="30" height="8" fill="#1e3a8a" stroke="#1e40af" strokeWidth="1" rx="1" />
                                          <text x="50" y="54" fontSize="6" fill="#fef3c7" textAnchor="middle" fontWeight="bold">SHOP</text>
                                          
                                          {/* Brick details */}
                                          <line x1="20" y1="55" x2="42" y2="55" stroke="#d97706" strokeWidth="0.5" opacity="0.5" />
                                          <line x1="58" y1="55" x2="80" y2="55" stroke="#d97706" strokeWidth="0.5" opacity="0.5" />
                                          <line x1="20" y1="75" x2="42" y2="75" stroke="#d97706" strokeWidth="0.5" opacity="0.5" />
                                          <line x1="58" y1="75" x2="80" y2="75" stroke="#d97706" strokeWidth="0.5" opacity="0.5" />
                                          
                                          {/* Sidewalk */}
                                          <rect x="10" y="90" width="80" height="8" fill="#94a3b8" stroke="#64748b" strokeWidth="1" />
                                          <line x1="10" y1="94" x2="90" y2="94" stroke="#64748b" strokeWidth="0.5" />
                                          
                                          {/* Potted plant decoration - left */}
                                          <rect x="22" y="82" width="6" height="8" fill="#b91c1c" stroke="#991b1b" strokeWidth="1" />
                                          <circle cx="25" cy="80" r="4" fill="#22c55e" />
                                          <circle cx="23" cy="78" r="2" fill="#16a34a" />
                                          <circle cx="27" cy="78" r="2" fill="#16a34a" />
                                          
                                          {/* Potted plant decoration - right */}
                                          <rect x="72" y="82" width="6" height="8" fill="#b91c1c" stroke="#991b1b" strokeWidth="1" />
                                          <circle cx="75" cy="80" r="4" fill="#22c55e" />
                                          <circle cx="73" cy="78" r="2" fill="#16a34a" />
                                          <circle cx="77" cy="78" r="2" fill="#16a34a" />
                                        </svg>
                            </button>
                        )}

                        {/* Shop Modal */}
                        {showShop && (
                            <div 
                                className="absolute inset-0 bg-black/80 z-[60] flex items-center justify-center p-4" 
                                onClick={(e) => e.stopPropagation()} 
                                onTouchStart={(e) => e.stopPropagation()}
                                onTouchMove={(e) => e.stopPropagation()}
                                onTouchEnd={(e) => e.stopPropagation()}
                            >
                                <div className="bg-gray-800 p-6 rounded-xl border border-gray-600 w-full max-w-sm shadow-2xl max-h-[80vh] overflow-y-auto" style={{ touchAction: 'pan-y' }}>
                                    <div className="flex flex-col justify-between items-left mb-4 top-0 bg-gray-800 pb-2 border-b border-gray-700">
                                        <div className="flex justify-between items-center top-0 pb-2">
                                            <h2 className="text-2xl font-bold text-white">Sky Bazaar</h2>
                                            <button onClick={() => setShowShop(false)} className="text-gray-400 hover:text-white">âœ•</button>
                                        </div>
                                        <div className="text-left text-gray-400 text-sm bottom-0">
                                            Balance: <span className="text-yellow-400 font-bold">{coins} $</span>
                                        </div>
                                    </div>
                                    
                                    {/* Boosters Section */}
                                    <div className="mb-6">
                                        <h3 className="text-gray-400 text-sm font-bold mb-2 uppercase tracking-wider">Boosters</h3>
                                        <div className="bg-gray-700 p-4 rounded-lg flex justify-between items-center mb-2">
                                            <div>
                                                <h3 className="text-yellow-400 font-bold text-lg">Jump Booster</h3>
                                                <p className="text-gray-300 text-xs">Double jump height (10s)</p>
                                            </div>
                                            <button 
                                                onClick={buyBooster}
                                                disabled={coins < 12}
                                                className={`px-4 py-2 rounded font-bold ${coins >= 12 ? 'bg-green-500 hover:bg-green-400 text-white' : 'bg-gray-500 text-gray-300 cursor-not-allowed'}`}
                                            >
                                                12 $
                                            </button>
                                        </div>
                                    </div>

                                    {/* Skins Section */}
                                    <div>
                                        <h3 className="text-gray-400 text-sm font-bold mb-2 uppercase tracking-wider">Skins</h3>
                                        <div className="space-y-2">
                                            {SKINS.map(skin => {
                                                const isOwned = ownedSkins.includes(skin.id);
                                                const isEquipped = currentSkin === skin.id;
                                                
                                                return (
                                                    <div key={skin.id} className={`bg-gray-700 p-3 rounded-lg flex justify-between items-center ${isEquipped ? 'border-2 border-yellow-500' : ''}`}>
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-10 h-10">
                                                                <skin.Component />
                                                            </div>
                                                            <div>
                                                                <h3 className="text-white font-bold">{skin.name}</h3>
                                                                {!isOwned && <p className="text-yellow-400 text-xs">{skin.price} $</p>}
                                                            </div>
                                                        </div>
                                                        
                                                        {isEquipped ? (
                                                            <span className="text-yellow-500 font-bold text-sm px-3">EQUIPPED</span>
                                                        ) : isOwned ? (
                                                            <button 
                                                                onClick={() => buySkin(skin.id, skin.price)}
                                                                className="px-3 py-1 rounded bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold"
                                                            >
                                                                EQUIP
                                                            </button>
                                                        ) : (
                                                            <button 
                                                                onClick={() => buySkin(skin.id, skin.price)}
                                                                disabled={coins < skin.price}
                                                                className={`px-3 py-1 rounded text-sm font-bold ${coins >= skin.price ? 'bg-green-500 hover:bg-green-400 text-white' : 'bg-gray-500 text-gray-300 cursor-not-allowed'}`}
                                                            >
                                                                BUY
                                                            </button>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <div className="text-center mt-6 pt-4 border-t border-gray-700 text-gray-400 text-sm bottom-0 bg-gray-800"></div>
                                </div>
                            </div>
                        )}
                        
                        {/* SFX Mute Toggle */}
                        <button 
                            onClick={(e) => { e.stopPropagation(); toggleMute(); }}
                            onTouchStart={(e) => e.stopPropagation()}
                            className="absolute top-4 right-4 z-50 p-2 bg-black/40 rounded-full border border-white/20 hover:bg-black/60"
                        >
                            <SpeakerIcon muted={isMuted} />
                        </button>

                        {/* Start Screen */}
                        {gameState === 'START' && (
                            <div className="absolute inset-0 flex items-center justify-center bg-black/70 text-white z-40">
                                <div className="flex flex-col items-center">
                                    <h1 className="text-5xl font-bold text-yellow-400 mb-2 drop-shadow-lg">SKY ASCENDER</h1>
                                    <p className="text-gray-300 mb-8">Hold Left/Right to Jump</p>
                                    <button onClick={initGame} className="px-10 py-4 bg-green-500 rounded-full text-2xl font-bold shadow-[0_4px_0_rgb(21,128,61)] active:shadow-none active:translate-y-1 transition-all animate-pulse animate-scale">
                                        START
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Game Over */}
                        {gameState === 'GAME_OVER' && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-red-900/90 text-white z-40">
                                <h2 className="text-4xl font-bold mb-2">FALLEN!</h2>
                                <div className="text-6xl font-black text-yellow-300 mb-2">{highScore}m</div>
                                <p className="text-gray-300 mb-8">Best Score</p>
                                <button onClick={initGame} className="px-10 py-4 bg-blue-500 rounded-full text-2xl font-bold shadow-[0_4px_0_rgb(29,78,216)] active:shadow-none active:translate-y-1 transition-all animate-pulse animate-scale">
                                    TRY AGAIN
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


